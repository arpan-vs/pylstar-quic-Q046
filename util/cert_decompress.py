import zlib
from crypto.fnv64a import FNV64A

from util.SessionInstance import SessionInstance


class cert_decomp:
    @staticmethod
    def cert_Decompress():
        common_crt_set = bytes.fromhex("04023000301d0603551d250416301406082b0601050507030106082b06010505070302305f06096086480186f842040106060b6086480186fd6d01071701303320457874656e6465642056616c69646174696f6e2053204c696d6974656431342053534c204341301e170d31322053656375726520536572766572204341302d6169612e766572697369676e2e636f6d2f452d63726c2e766572697369676e2e636f6d2f452e636572300d06092a864886f70d010105050003820101004a2e636f6d2f7265736f75726365732f637073202863293030090603551d1304023000301d300d06092a864886f70d010105050003820101007b301d0603551d0e30820122300d06092a864886f70d01010105000382010f003082010a0282010100d26f646f63612e636f6d2f432e63726c301d0603551d0e04160414b42e676c6f62616c7369676e2e636f6d2f72300b0603551d0f0404030201300d06092a864886f70d01010505003081ca310b30090603550406130255533110300e060355040813074172697a6f6e61311330110603550407130a53636f74747364616c65311a3018060355040a1311476f44616464792e636f6d2c20496e632e31333031060355040b132a687474703a2f2f6365727469666963617465732e676f64616464792e636f6d2f7265706f7369746f72793130302e06035504031327476f204461646479205365637572652043657274696669636174696f6e20417574686f726974793111300f060355040513083037393639323837301e170d3131300e0603551d0f0101ff0404030205a0300c0603551d130101ff04023000301d300f0603551d130101ff04053003010100301d0603551d250416301406082b0601050507030106082b06010505070302300e0603551d0f0101ff0404030205a030330603551d1f042c302a3028a026a0248622687474703a2f2f63726c2e676f64616464792e636f6d2f676473312d32302a302806082b06010505070201161c68747470733a2f2f7777772e766572697369676e2e636f6d2f63707330343030303030305a170d31333035303906082b06010505073002862d687474703a2f2f733039303706082b06010505070230440603551d20043d303b3039060b6086480186f84501071706310b3009060355040613024742311b5331173015060355040a130e566572695369676e2c20496e632e311f301d060355040b1316566572695369676e205472757374204e6574776f726b313b3039060355040b13325465726d73206f66207573652061742068747470733a2f2f7777772e766572697369676e2e636f6d2f72706120286329303110300e060355040713075331133011060355040b130a4731133011060b2b0601040182373c0201031302553116301406035504031431193017060355040313311d301b060355040f131450726976617465204f7267616e697a6174696f6e31123121301f060355040b1318446f6d61696e20436f6e74726f6c2056616c69646174656431143131302f060355040b1328536565207777772e723a2f2f7365637572652e67476c6f62616c5369676e3153657276657243412e63726c566572695369676e20436c6173732033204563726c2e67656f74727573742e636f6d2f63726c732f7364311a3018060355040a687474703a2f2f4556496e746c2d636372742e677777772e6769636572742e636f6d2f316f6373702e766572697369676e2e636f6d3039726170696473736c2e636f732e676f64616464792e636f6d2f7265706f7369746f72792f30818006082b0601050507010104743072302406082b060105050730018618687474703a2f2f6f6373702e676f64616464792e636f6d2f304a06082b06010505073002863e687474703a2f2f6365727469666963617465732e676f64616464792e636f6d2f7265706f7369746f72792f67645f696e7465726d6564696174652e637274301f0603551d23041830168014fdac6132936c45d6e2ee855f9abae7769968cce730278629687474703a2f2f638630687474703a2f2f73")

        decompressor = zlib.decompressobj(15,common_crt_set)
        cert = decompressor.decompress(SessionInstance.get_instance().cert_chain)
        size = int(cert[:2][::-1].hex(),16)
        SessionInstance.get_instance().cert_localhost = cert[4:4 + size].hex()

        SessionInstance.get_instance().expected_leaf_certificate = FNV64A.generate_hash(cert[4:4 + size])
        SessionInstance.get_instance().cached_certificate = SessionInstance.get_instance().expected_leaf_certificate

        cert = cert[4 + size:]
        while len(cert) > 0:
            size = int(cert[:2][::-1].hex(),16)
            certificate = cert[4:4 + size]

            SessionInstance.get_instance().cached_certificate += FNV64A.generate_hash(certificate)

            cert = cert[4 + size:]